# KR260 FPGA Support Template

This directory contains the template files for Xilinx Kria KR260 FPGA support in Chipyard.

## Board Specifications

- **FPGA**: Zynq UltraScale+ MPSoC xczu5eg-sfvc784-1-i / xck26-sfvc784-2LV-c
- **DDR Memory**: 4GB DDR4 (connected to PS, not directly accessible from PL)
- **Processing System**: ARM Cortex-A53 quad-core + Cortex-R5 dual-core
- **Input Clock**: 25MHz single-ended on pin C3 (LVCMOS33)
- **System Clock**: Generated by Xilinx Clocking Wizard (default 50MHz, configurable)

## Clock Architecture

The KR260 has a **25MHz single-ended clock input on pin C3**. This clock is fed through a Xilinx Clocking Wizard IP to generate the system clock:

```
25MHz (Pin C3) → Clocking Wizard → System Clock (default 50MHz)
                  (MMCM/PLL)        (user configurable: 25-200MHz)
```

**Configuring System Clock Frequency:**
```scala
// In Configs.scala - change freqMHz parameter
class MyCustomConfig extends Config(
  new WithBaseKR260Tweaks(freqMHz=75, sizeKB=128) ++  // 75MHz system clock
  ...
)
```

**Recommended Frequencies:**
- **50MHz** (default) - Safe, good timing closure
- **75MHz** - Moderate performance
- **100MHz** - Higher performance, may require timing optimization
- **125MHz+** - Advanced, requires careful timing constraints

## Reset Button Configuration

**The KR260 does not have a dedicated reset button accessible from PL** like the Arty A7-100T. Instead, it provides 4 PMOD connectors for custom I/O.

**Reset Implementation:**
- Reset signal uses **PMOD pin AH12**
- I/O Standard: LVCMOS33 (3.3V)
- Active-low with internal pull-up
- Pin assignment in `KR260Shell.scala` (line ~177)

**Customizing Reset Pin:**
Edit `base/base-fpga-shells/src/main/scala/shell/xilinx/KR260Shell.scala`:
```scala
xdc.addPackagePin(reset, "AH12")  // Change to your desired PMOD pin
```

**Hardware Setup:**
- Connect a normally-open push button between pin AH12 and GND
- When pressed: pin pulled low (active reset)
- When released: internal pull-up pulls high (inactive)

See [KR260_RESET_PMOD.md](../../../KR260_RESET_PMOD.md) for detailed reset button configuration.

## Important Note About DDR4 Memory

**The KR260's 4GB DDR4 memory is connected to the Processing System (PS), not the Programmable Logic (PL).** This means:

1. **For pure PL designs**: DDR is not directly accessible. Use on-chip memory (BRAM/scratchpad).
2. **To access DDR**: You must use the Zynq UltraScale+ MPSoC IP and access memory through PS.
3. **Current default**: Configurations use 64KB scratchpad memory in PL for simplicity.

If you need more memory, you can:
- Increase scratchpad size (limited by BRAM availability)
- Use Zynq MPSoC IP to access PS DDR (requires adding PS to the design)
- Add external DDR4 to PL (requires custom hardware - not available on stock KR260)

## Directory Structure

```
base/src/main/scala/kr260/
├── Configs.scala           # Configuration classes for KR260
├── HarnessBinders.scala    # Harness binders for peripherals (UART, SPI, JTAG, DDR)
├── Harness.scala           # Top-level harness implementation
└── README.md              # This file

base/src/main/resources/kr260/
├── sdboot/                # SD card bootloader for DDR-based systems
│   ├── Makefile
│   ├── head.S
│   ├── sd.c
│   ├── kprintf.c
│   ├── kprintf.h
│   ├── common.h
│   ├── include/
│   └── linker/
└── sdboot-scratchpad/     # Bootloader for ASIC-compatible scratchpad mode
    └── (same structure as sdboot/)
```

## Available Configurations

All configurations use on-chip scratchpad memory (BRAM). The KR260's 4GB DDR4 is connected to the PS (Processing System) and requires Zynq MPSoC integration to access.

### 1. BaseRocketKR260Config (Default - Recommended)
- Single RV32I core
- **32KB Scratchpad RAM** (on-chip BRAM)
- **2KB L1 I-Cache** (8 sets × 4 ways × 64B) - reduced to save BRAM
- **2KB L1 D-Cache** (8 sets × 4 ways × 64B) - reduced to save BRAM
- **50 MHz clock** (generated from 25MHz input)
- Suitable for small embedded programs and FPGA prototyping

### 2. RocketKR260Config
- Single RV32I core
- **128KB Scratchpad RAM** (on-chip BRAM)
- **75 MHz clock** (generated from 25MHz input)
- For slightly larger programs

### 3. RocketKR260HighPerfConfig
- RV64GC core with full RISC-V ISA
- **256KB Scratchpad RAM** (on-chip BRAM)
- **125 MHz clock** (generated from 25MHz input)
- High-performance configuration

### 4. DualCoreRocketKR260Config
- Dual RV32I cores
- **128KB Scratchpad RAM** (on-chip BRAM)
- **100 MHz clock** (generated from 25MHz input)
- Multi-core configuration

## Peripherals Configuration

Default peripheral memory map:
- **UART0**: 0x64000000
- **SPI0**: 0x64001000

## TODO: Required Steps to Complete KR260 Support

### 1. Create KR260Shell.scala
Create a shell file in `base/base-fpga-shells/src/main/scala/shell/xilinx/KR260Shell.scala` that includes:
- Clock overlay (200MHz input)
- DDR4 overlay for 4GB memory
- LED overlays
- UART overlay
- SPI overlay
- JTAG overlay
- Proper pin constraints for KR260 board

### 2. Update Pin Assignments
The current pin assignments in `HarnessBinders.scala` are **PLACEHOLDERS**. You need to:
- Consult the KR260 schematics
- Refer to Kria KR260 Robotics Starter Kit User Guide (UG1089)
- Update pin assignments based on your PMOD or connector usage
- Map UART, SPI, JTAG, and GPIO pins correctly

### 3. Create DDR4 MIG IP
The KR260 uses DDR4 memory. You'll need to:
- Create a Xilinx MIG (Memory Interface Generator) IP for DDR4
- Configure it for the KR260's memory specifications
- Create a corresponding Scala wrapper similar to `XilinxArty100TMIG`

### 4. Test and Validate
- Build a simple design with BaseRocketKR260Config
- Verify bootrom compilation
- Test UART communication
- Validate DDR4 memory access (for non-scratchpad configs)

## Building Bootrom

The bootrom must be built before generating the design:

```bash
cd base/src/main/resources/kr260/sdboot
make clean
make PBUS_CLK=100000000 bin
```

For scratchpad mode:
```bash
cd base/src/main/resources/kr260/sdboot-scratchpad
make clean
make PBUS_CLK=100000000 bin
```

## Usage Example

To use the KR260 configurations in your Chipyard build:

```bash
cd /path/to/chipyard
make SUB_PROJECT=kr260 CONFIG=BaseRocketKR260Config
```

## Important Notes

1. **Shell Implementation**: The `KR260Shell` referenced in `Harness.scala` is a placeholder. You must implement it properly in the fpga-shells directory.

2. **Pin Constraints**: All pin assignments are placeholders and MUST be updated based on:
   - KR260 carrier card pinout
   - PMOD connector assignments
   - FMC connector (if used)
   - Your specific hardware configuration

3. **DDR4 Configuration**: The DDR overlay assumes a `DDRKR260PlacedOverlay` exists. This needs to be implemented with proper MIG IP integration.

4. **Clock Frequency**: Default is 100-125 MHz for the design. Adjust based on your timing requirements.

5. **Memory Map**: The default peripheral addresses are based on Arty100T. Verify they don't conflict with your system requirements.

## Reference Files

The KR260 template was created based on the Arty100T implementation:
- `base/src/main/scala/arty100t/` - Reference for configuration structure
- `base/base-fpga-shells/src/main/scala/shell/xilinx/Arty100TShell.scala` - Reference for shell implementation

## Resources

- [Kria KR260 Robotics Starter Kit](https://www.xilinx.com/products/som/kria/kr260-robotics-starter-kit.html)
- [UG1089: Kria KR260 User Guide](https://docs.xilinx.com/r/en-US/ug1089-kria-kr260-starter-kit)
- [Zynq UltraScale+ MPSoC Documentation](https://www.xilinx.com/products/silicon-devices/soc/zynq-ultrascale-mpsoc.html)

## Contributing

When implementing the shell and completing the KR260 support:
1. Update pin assignments with actual values
2. Test all peripherals
3. Document any board-specific quirks
4. Update this README with actual build instructions
5. Add constraint files (.xdc) if needed

## License

Follow the same license as the parent Chipyard project.
