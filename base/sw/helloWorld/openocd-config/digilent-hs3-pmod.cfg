# OpenOCD config: Digilent JTAG-HS3 connected to *PMOD* (fabric IO JTAG)
#
# This is the same target setup as olimex.cfg, but with Digilent FTDI settings.
#
# IMPORTANT:
# - This is for when you wire the probe to the SoC JTAG that you routed to PMOD
#   pins via WithArty100TJTAG (i.e. NOT the Arty board's dedicated FPGA JTAG header).
# - If you connect to the Arty JTAG header, you'll see the Xilinx FPGA IDCODE and
#   you need a BSCAN-tunnel based flow instead.

# WIRING (your stated mapping):
# - PMOD_B pin 1 = E15 = TMS
# - PMOD_B pin 2 = E16 = TDI
# - PMOD_B pin 3 = D15 = TDO
# - PMOD_B pin 4 = C15 = TCK
#
# REQUIRED (common HS3 gotcha):
# - HS3 GND must connect to board GND (e.g. PMOD pin 5)
# - HS3 VREF/VTREF must connect to target I/O voltage (Arty PMOD VCC = 3.3V, e.g. PMOD pin 6)
#   If VTREF is not present, HS3 often drives nothing and OpenOCD reports “all zeroes”.

telnet_port 4445

# Start very slow; once it works you can increase.
adapter speed 10

adapter driver ftdi
# Your machine has two Digilent FTDI devices (0403:6014 and 0403:6010).
# Pin OpenOCD to the JTAG-HS3 by serial to avoid grabbing the wrong one.
adapter serial 210299BDC8E9

ftdi device_desc "Digilent USB Device"
ftdi vid_pid 0x0403 0x6014

# NOTE: HS3 uses FT232H (single interface). Do not use `ftdi channel 1`.

# HS3 layout from Digilent support (matches riscv-openocd's digilent_jtag_hs3.cfg)
ftdi layout_init 0x2088 0x308b
ftdi layout_signal nSRST -data 0x2000 -noe 0x1000

reset_config none

# Select JTAG transport after adapter is configured.
transport select jtag

# ----------------------------------------------
# Target configuration
# ----------------------------------------------
set _CHIPNAME riscv
jtag newtap $_CHIPNAME cpu -irlen 5

set _TARGETNAME_0 $_CHIPNAME.cpu0

target create $_TARGETNAME_0 riscv -chain-position $_CHIPNAME.cpu -rtos hwthread

target smp $_TARGETNAME_0

$_TARGETNAME_0 configure -work-area-phys 0x80000000 -work-area-size 0x00002000 -work-area-backup 1

init
halt

echo "Ready for Remote Connections"
