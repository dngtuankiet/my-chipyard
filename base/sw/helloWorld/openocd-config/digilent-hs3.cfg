# OpenOCD config for Digilent JTAG-HS3 (FT232H, VID:PID 0403:6014)
#
# NOTE:
# - The Arty onboard Digilent interface is typically 0403:6010 (FT2232) and is a
#   different device from the external JTAG-HS3.
# - This config is for the external JTAG-HS3 (0403:6014). We pin by USB serial.

telnet_port 4445

# Use OpenOCD's official HS3 interface definition (FT232H mapping + OE/SRST handling).
# If OpenOCD can't find this, run OpenOCD with `-s $RISCV/share/openocd/scripts`.
source [find interface/ftdi/digilent_jtag_hs3.cfg]

# Pin to the external HS3 by serial (edit if your HS3 has a different serial).
adapter serial 210299BDC8E9

# Start very slow for bring-up; increase once stable.
# If you see intermittent DM/DMI failures (e.g. dmcontrol/dmstatus reading as 0), slower often helps.
adapter speed 10

# Signal-integrity knobs:
# - Many Digilent/FTDI JTAG pods work better sampling TDO on the falling edge.
ftdi tdo_sample_edge falling

# NOTE: Some OpenOCD builds support `tms_sequence long`, but OpenOCD 0.12.0 on this
# system does not. If you need this knob, use the riscv-openocd bundled with Chipyard.

reset_config none

transport select jtag


# ----------------------------------------------
# Target configuration (Chipyard/Rocket uses a 5-bit IR DTM)
# ----------------------------------------------
set _CHIPNAME riscv
jtag newtap $_CHIPNAME cpu -irlen 5

set _TARGETNAME_0 $_CHIPNAME.cpu0

target create $_TARGETNAME_0 riscv -chain-position $_CHIPNAME.cpu -rtos hwthread

target smp $_TARGETNAME_0

# Optional: speed up memory access (may or may not help depending on DM configuration)
# riscv set_mem_access sysbus progbuf

# Work area in RAM
$_TARGETNAME_0 configure -work-area-phys 0x80000000 -work-area-size 0x00002000 -work-area-backup 1

#adapter speed 1000

init
halt

echo "Ready for GDB: target remote localhost:3333"
